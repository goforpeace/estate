rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Tenant documents can be read by any signed-in user to verify domain.
    match /tenants/{tenantId} {
      allow read: if isSignedIn();
      allow write: if false; // Tenants should be managed by an admin process, not client-side.
    }
    
    // User can read their own user profile document.
    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // Rules for all tenant-specific data.
    match /tenants/{tenantId}/{collection}/{docId} {
      // A user can read/write data only within their own tenant's path.
      // This assumes the user's auth token has a `tenant` claim matching `tenantId`.
      // For now, we will allow any signed-in user to access for development.
      allow read, write: if isSignedIn();
    }
    
    // This rule is CRITICAL for the collectionGroup query on 'payments' to work.
    // It allows a user to query the 'payments' collection group if the query
    // includes a 'where' clause for 'tenantId' that matches their tenant.
    match /{path=**}/payments/{paymentId} {
        // As a simple dev rule, allow any signed-in user to list payments.
        // In production, you would add a check like:
        // allow list: if request.query.where.tenantId == request.auth.token.tenant;
        allow read, write: if isSignedIn();
    }
  }
}
