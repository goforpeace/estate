rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    //============================================================
    //  Helper Functions
    //============================================================

    /**
     * Returns true if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user has the 'Admin' role for the entire system.
     * This is for the top-level admin panel (gopon).
     */
    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    /**
     * Checks if the user is a member of the tenant they are trying to access.
     * For now, this just checks if they are signed in. This can be expanded later
     * for more complex role systems within a tenant.
     */
    function isTenantMember(tenantId) {
        // In a more complex app, you might check a 'members' subcollection:
        // return exists(/databases/$(database)/documents/tenants/$(tenantId)/members/$(request.auth.uid));
        return isSignedIn();
    }

    //============================================================
    //  Admin-Specific Rules
    //============================================================
    
    /**
     * Admin Roles Collection:
     * - This collection is used to grant system-wide admin privileges.
     * - Only Super Admins can see who else is an admin.
     * - Writes are disabled from the client to prevent privilege escalation.
     */
    match /roles_admin/{userId} {
      allow read, list: if isSuperAdmin();
      allow write: if false; 
    }
    
    //============================================================
    //  Tenant Data Rules
    //============================================================

    match /tenants/{tenantId} {
        // This rule allows Super Admins to manage the tenant documents themselves.
        // It does NOT grant access to subcollections.
        allow read, list, create, update, delete: if isSuperAdmin();

        /**
         * Projects Collection:
         * - Any authenticated user of the tenant can read projects.
         * - Any authenticated user of the tenant can create, update, or delete projects.
         *   (This can be restricted to tenant admins later if needed).
         */
        match /projects/{projectId} {
          allow read, list, create, update, delete: if isTenantMember(tenantId);
          
           /**
             * inflowTransactions (Payments) Subcollection within Projects:
             * - Any signed-in tenant member can create, read, and list their own payments.
             */
            match /inflowTransactions/{transactionId} {
                allow create, read, list, update, delete: if isTenantMember(tenantId);
            }
        }

        /**
         * Customers Collection:
         * - Any authenticated user of the tenant can manage customers.
         */
        match /customers/{customerId} {
          allow read, list, create, update, delete: if isTenantMember(tenantId);
        }
        
        /**
         * Flat Sales Collection:
         * - Any authenticated user of the tenant can manage sales.
         */
        match /flatSales/{saleId} {
          allow read, list, create, update, delete: if isTenantMember(tenantId);

           /**
            * Payments Subcollection:
            * - Any authenticated user of the tenant can manage payments for a sale.
            */
          match /payments/{paymentId} {
             allow read, list, create, update, delete: if isTenantMember(tenantId);
          }
        }
        
        /**
         * Organization Details:
         * - Any authenticated user of the tenant can manage the organization profile.
         */
        match /organization/{orgId} {
             allow read, list, create, update, delete: if isTenantMember(tenantId);
        }
    }

    /**
     * Counters for IDs:
     * - This is a backend-only collection used for atomic operations (transactions).
     * - Client-side writes must be disabled. Reads can be allowed if needed by client logic.
     */
    match /counters/{counterId} {
      allow read: if isSignedIn();
      allow write: if false; 
    }
    
     /**
     * Users Collection (Global):
     * - This assumes users are global and not nested under tenants.
     * - A user can create their own user document.
     * - A user can read and update their own profile.
     * - Super Admins can list any user.
     */
    match /users/{userId} {
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow read, update: if isSignedIn() && request.auth.uid == userId;
      allow list: if isSuperAdmin();
    }
  }
}
